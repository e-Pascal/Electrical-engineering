# Часть 4. Разработка электронного устройства X

## ПИТАНИЕ
### Микроконтроллер (МК)

Питание микроконтроллера разделено на несколько доменов (рисунок 1). Это позволяет более грамотно организовать питание периферии и уменьшить шумы, поступающие из одной части в другую. Система питания включает в себя:
- VDD: внешнее питание для части блока ввода-вывода, внутреннего регулятора и аналоговых систем, таких как сброс, управление питанием и внутреннее тактирование;
- VDDA: внешнее аналоговое питание для АЦП, ЦАП, операционных усилителей, компараторов и источника опорного напряжения. Питание VDDA независимо от VDD;
- VREF: используется для установки точного уровня опорного напряжения. 
- VBAT: питает часы реального времени RTC, внешний генератор 32 кГц и регистры восстановления, когда отсутствует основное питание.

Для того чтобы помехи, которые довольно часто бывают в цепях питания, не влияли на результаты измерения, устанавливаются фильтрующие конденсаторы. По этой же причине в некоторых схемах производят разделение земли на VSS и VSSA, а на вывод VDDA подается напряжение через фильтрующий дроссель. Если не планируется использование аналоговой части и не нужны точные измерения, то на VDDA можно подать то же напряжение что и на VDD, а вывод VSSA подключить к VSS. Подключать выводы VDDA и VSSA нужно обязательно!

<p align="center" > <img src="./pic/p1.png"></p>

<p align="center" >Рисунок 3.1 – ...</p>

### Питание ПЛИС

Программируемые логические интегральные схемы находят все большее применение в разнообразных областях и решают различные задачи — от простой логики до цифровой обработки сигналов, и поэтому, для их питания требуются различные уровни мощности. Мощность, необходимая для питания ПЛИС, определяется следующими факторами: тип ПЛИС, ее рабочая частота, температура окружающей среды, число задействованных линий ввода-вывода и, конечно, процент используемых ресурсов ПЛИС. 

ПЛИС, как правило, имеют довольно сложные требования к питанию, включая несколько линий питания (часто при разных напряжениях), жесткие допуски напряжения, последовательность включения питания и плавный запуск. 

Требования к системе питания ПЛИС: 
1. Ограничить параметры переходного процесса при включении питания.
2. Максимально снизить уровень высокочастотного шума, неизбежного в цифровых высокоскоростных схемах. Для этого необходимы:
    - раздельные шины питания для различных основных потребителей тока;
    - установка достаточного количества фильтрующих конденсаторов.

Если эти требования не выполняются, то работа может быть ненадежной или ПЛИС может быть повреждена.

Структурная схема системы питания ПЛИС состоит из первичного источника питания, формирующего входное напряжение (Vin) для стабилизатора напряжения, схемы, устанавливающей последовательность подачи различных напряжений и по необходимости схемы слежения за уровнями напряжений (супервизор). Одним из ключевых компонентов системы питания является цепочка фильтрующих конденсаторов вокруг ПЛИС. Они позволяют распределить рабочий ток между потребителями, используя низкоимпедансные пути прохождения тока, тем самым снижая уровень высокочастотного шума. 

Все ПЛИС нуждаются в источнике напряжения питания ядра, но большинство сложных ПЛИС испытывают потребность и в отдельном источнике напряжения питания для блоков ввода-вывода, источнике опорных напряжений, источнике напряжения для дополнительных функций. 
  
<p align="center" > <img src="./pic/p2.png"></p>

<p align="center" >Рисунок 3.1 – ...</p>

Для питания разных функциональных блоков ПЛИС используются различные уровни напряжения. Для обеспечения одного уровня напряжения необходим один вторичный источник питания. 

Рассмотрим более подробно основные типы напряжения питания, необходимые для ПЛИС:
- VCCINT. Внешнее напряжение питания ядра. Является основным питающим напряжением ПЛИС и, как правило, обеспечивает большую часть мощности, затрачиваемой в ПЛИС. Основное напряжение источника зависит от семейства ПЛИС. Напряжение питания ядра может использоваться и для питания конфигурационного перепрограммируемого постоянного запоминающего устройства. Для современных ПЛИС это напряжение обычно находится в диапазоне от 0,9 В до 1,2 В с допуском 5%.
- VCCO. Напряжение питания блоков ввода-вывода. Уровни напряжения определяются внешними цифровыми схемами и, поскольку многие современные ПЛИС имеют несколько портов ввода-вывода, каждый из них может питаться от своего источника для обеспечения интерфейса с различными типами цифровой логики. 
- VCCAUX. Вспомогательное напряжение питания, необходимое для различных вспомогательных функций ПЛИС, например для устройства управления тактовой частотой или интерфейсом JTAG. Вспомогательные устройства более чувствительны к шуму, нежели другие, и поэтому VCCAUX имеет более высокие требования по развязке для минимизации наведенного шума. В случае если источник питания ядра напряжением VCCO обладает низким шумом, от него можно запитать блоки вспомогательных функций
 
<p align="center" > <img src="./pic/p3.png"></p>

<p align="center" >Рисунок 4. – ...</p>

## Тактирование
Система тактирования является основным функциональным блоком, синхронизирующим все процессы и определяющим скорость их выполнения.

### Микроконтроллер

Микроконтроллер
Существует 4 способа задания тактовой частоты микроконтроллера:
•	использовать внутренний генератор;
•	использовать внешний кварц;
•	использовать внешний генератор;
•	использовать RC-цепочку.
Тактирование от внутреннего генератора

При этом способе нам не нужно подключать какие либо внешние детали. Тактирование осуществляется от RC-генератора, который находится внутри МК. Этот способ не подойдет, если нужны точные интервалы времени, т. к.  задающая частота RC-генератора плавает в зависимости от температуры.

Тактирование от внешнего кварцевого резонатора
Для того чтобы подключить осциллятор нужно знать расположение выводов МК и их название. Схема подключения приведена в спецификации к данному МК. Два основных недостатка этого способа синхронизации – необходимость подключения дополнительных внешних конденсаторов (рекомендуемые номиналы которых можно найти в спецификации к МК) и хрупкость кристаллов кварца. Оба этих недостатка могут быть устранены, если использовать керамический резонатор. Керамические резонаторы существенно более стойки к ударной нагрузке, и многие из них имеют встроенные конденсаторы, вследствие чего количество требуемых внешних компонентов уменьшается с трех до одного.
Тактирование от внешнего генератора
При помощи внешнего тактового генератора можно задать любую частоту синхронизации. Высокая стабильность создаваемой частоты (временная и температурная). Однако внешний кварцевый генератор занимает большой объём. Также иногда требуется отдельная линия питания.
Тактирование с использованием RC-цепочки
В этом случае необходимая частота тактовых импульсов задается путем соответствующего выбора постоянной времени RC-цепи. Это самый дешевый способ задания частоты, но наименее точный. Если кварц обеспечивает поддержание частоты с точностью в тысячные доли процента, керамический резонатор – в десятые доли процента, то RC-цепь дает точность порядка десятков процентов. Точность задания тактовой частоты можно повысить, используя переменные резистор или конденсатор. Однако при этом сложность и цена генератора увеличатся.
   
<p align="center" > <img src="./pic/p4.png"></p>

<p align="center" >Рисунок 3.1 – ...</p>

<p align="center" > <img src="./pic/p5.png"></p>

<p align="center" >Рисунок 4 – ...</p>

<p align="center" > <img src="./pic/p6.png"></p>

<p align="center" >Рисунок 4 – ...</p>

### ПЛИС
В качестве генератора стабильной частоты используются внешние кварцевые или микромеханические генераторы. В некоторых случаях внешний генератор может быть подключен не напрямую к ПЛИС, а через буферные схемы для минимизации искажений сигнала и увеличения надежности. 
 
<p align="center" > <img src="./pic/p7.png"></p>

<p align="center" >Рисунок 4 – ...</p>
 
## ИНТЕРФЕЙСЫ
Интерфейс – совокупность механических, электрических и программных средств, с помощью которых компоненты системы объединяются для решения задачи обмена информации.

Каждый вывод может использоваться в режиме:
•	Input floating – вход без подтягивающего резистора, брошенный в воздухе вход.
•	Input pull-up – вход с подтягивающим резистором, подключенным к питанию.
•	Input pull-down - вход с подтягивающим резистором, подключенным к общему проводу (земле).
•	Analog – аналоговый вход ( вход АЦП, компараторов и т.п.).
•	Output open-drain – выход с открытым стоком. Функционально аналогичен выходу с открытым коллектором. При низком логическом уровне замыкает вывод на землю, при высоком – бросает в воздухе.
•	Output push-pull – обычный активный выход. При низком логическом уровне напряжение на выводе равно 0, при высоком – напряжение близко к напряжению питания.

### Интерфейсы программирования и отладки

Для того чтобы МК или ПЛИС могли решать задачи и выполнять определенные функции, файл прошивки нужно записать в память микроконтроллераили ПЛИС или, проще говоря, прошить.
Для прошивки применяется устройство, называемое программатор. В зависимости от типа программатора в большинстве случаев вход подключается к COM или USB порту, а выход к определенным выводам микросхемы МК или ПЛИС.

#### Популярные интерфесы отладки и программирования

1. JTAG (Joint Test Action Group)
JTAG — это стандартный интерфейс для тестирования и программирования цифровых устройств. Он изначально был разработан для тестирования соединений на печатных платах, но широко используется и для программирования микроконтроллеров и ПЛИС, а также для отладки.
Использует несколько линий 
TCK (TCLK) (test clock)- тестовая синхронизация
TDI (test data in) - входные тестовые данные 
TDO (test data out) - выходные тестовые данные 
TMS (test mode select) - выбор тестового режима
TRST (test reset) - сброс JTAG в начальное состояние  (используется не всегда)
 
<p align="center" > <img src="./pic/p8.png"></p>

<p align="center" >Рисунок 4 – ...</p>

2. SWD (Serial Wire Debug)
SWD — это интерфейс для отладки, разработанный как часть архитектуры ARM. Он представляет собой сокращенную версию JTAG и предназначен для упрощения отладочных интерфейсов с меньшим количеством линий связи.
 SWD использует всего две линии — SWDIO (данные) и SWCLK (тактовый сигнал), что делает его более компактным по сравнению с JTAG.
 
<p align="center" > <img src="./pic/p9.png"></p>

<p align="center" >Рисунок 4 – ...</p>

3. SWIM (Single Wire Interface Module)
SWIM — это интерфейс для программирования и отладки, разработанный компанией STMicroelectronics для своих 8-битных микроконтроллеров STM8. Он использует только одну линию для передачи данных, что упрощает его интеграцию в схемы. Предоставляет доступ к памяти и регистраторам микроконтроллера.
 
 <p align="center" > <img src="./pic/p10.png"></p>

<p align="center" >Рисунок 4 – ...</p>

### Интерфейсы передачи/обмена пользовательскими данными

#### UART 
UART (Universal Asynchronous Receiver-Transmitter) — это последовательный интерфейс, который используется для асинхронной передачи данных между устройствами. Это один из самых простых и популярных интерфейсов для передачи данных между устройствами.
 Обычно требует двух линий — TX (Transmitter / передача данных) и RX ( Receiver / прием данных), а также иногда линии для контроля потока, такие как CTS и RTS. В отличие от JTAG и SWD, UART не требует отдельного тактового сигнала, так как данные передаются в асинхронном режиме. Используется также для загрузки прошивок в микроконтроллеры (bootloader), простой отладки и мониторинга данных через последовательный интерфейс.
Для связи двух устройств понадобятся два провода, причем соединять их следует крест-накрест RX первого в TX второго и наоборот (куда один передает, там другой принимает). Связь в UART может быть симплексной (данные передаются только в одном направлении), полудуплексной (каждая сторона  передает данные, но не одновременно) или полнодуплексной (одновременная передача и прием данных).
 
 <p align="center" > <img src="./pic/p11.jpg"></p>

<p align="center" >Рисунок 4 – ...</p>

С помощью UART также можно можно связать микроконтроллер и компьютер, но есть одна проблема: у UART интерфейса логические уровни 0 и +5 вольт, а в компьютере логические уровни в интерфейсе RS-232 могут быть от -25 до -3 вольт и от +3 до +25 вольт. Для этого применяют специальный преобразователь уровней на микросхеме MAX232:
 
 <p align="center" > <img src="./pic/p12.jpg"></p>

<p align="center" >Рисунок 4 – ...</p>

Все сигналы UART передаются специально выбранными уровнями, обеспечивающими высокую помехоустойчивость связи. Отметим, что данные передаются в инверсном коде (логической единице соответствует низкий уровень, логическому нулю — высокий уровень. 

<p align="center" > <img src="./pic/p12.png"></p>

<p align="center" >Рисунок 4 – ...</p>

#### SPI
SPI (Serial Peripheral Interface) - последовательный периферийный интерфейс, предназначен для организации обмена данными между двумя устройствами. С его помощью может осуществляться обмен данными между микроконтроллером или ПЛИС и различными устройствами, такими, как АЦП, FLASH-ПЗУ и др. Кроме того, через интерфейс SPI может осуществляться программирование.
  

<p align="center" > <img src="./pic/p13.png"></p>

<p align="center" >Рисунок 4 – ...</p>

<p align="center" > <img src="./pic/p14.jpg"></p>

<p align="center" >Рисунок 4 – ...</p>

CPOL — исходный уровень сигнала синхронизации (если CPOL=0, то линия синхронизации до начала цикла передачи и после его окончания имеет низкий уровень (т.е. первый фронт нарастающий, а последний — падающий), иначе, если CPOL=1, — высокий (т.е. первый фронт падающий, а последний — нарастающий));
CPHA — фаза синхронизации; от этого параметра зависит, в какой последовательности выполняется установка и выборка данных (если CPHA=0, то по переднему фронту в цикле синхронизации будет выполняться выборка данных, а затем, по заднему фронту, — установка данных; если же CPHA=1, то установка данных будет выполняться по переднему фронту в цикле синхронизации, а выборка — по заднему). Информация по режимам SPI обобщена в таблице.
 
 <p align="center" > <img src="./pic/p15.png"></p>

<p align="center" >Рисунок 4 – ...</p>

#### I2C
I2C (Inter-Integrated Circuit) - последовательный асимметричный интерфейс между интегральными схемами внутри электронных приборов.В положительную сторону отличается от UART более высокой скоростью стабильной передачи данных и более стабильной передачей данных на высокой скорости. Кроме того, благодаря своей архитектуре, позволяет подключать к одной шине, состоящей из двух проводов SDA (данные) и SCL (тактовые импульсы), до 128 устройств одновременно, не используя дополнительного оборудования, если не считать двух подтягивающих резисторов.
 
 <p align="center" > <img src="./pic/p16.png"></p>

<p align="center" >Рисунок 4 – ...</p>

Устройство, подключенное к шине, должно быть либо ведущим, либо подчиненным. Ведущее устройство инициирует передачу данных путем передачи адреса подчиненного устройства и типа передачи: чтение или запись. Если к шине подключено несколько ведущих устройств и некоторая их часть одновременно инициировала передачу, применяется механизм арбитража, который учитывает приоритет этих устройств.
<p align="center" > <img src="./pic/p17.png"></p>

<p align="center" >Рисунок 4 – ...</p>

<p align="center" > <img src="./pic/p18.png"></p>

<p align="center" >Рисунок 4 – ...</p>

<p align="center" > <img src="./pic/p19.pngg"></p>

<p align="center" >Рисунок 4 – ...</p>

<p align="center" > <img src="./pic/p20.png"></p>

<p align="center" >Рисунок 4 – ...</p>
    
Ведущее устройство сигнализирует о начале транзакции генерацией на шине условия START (S). Затем, передается пакет адреса с адресом подчиненного устройства (ADDRESS) и указание желаемого направления передачи данных, т.е. чтение или запись (R/W). По завершении передачи всех пакетов данных (DATA), ведущее устройство генерирует на шине условие STOP (P) и транзакция завершается. После приема каждого байта получатель данных генерирует бит подтверждения (A или ACK) или неподтверждения (/A или NACK).
…………………………………………………………………………………………………………...

#### CAN

CAN (Control Area Network) — последовательная магистраль, обеспечивающая увязку в сеть "интеллектуальных" устройств ввода/вывода, датчиков и исполнительных устройств некоторого механизма или даже предприятия. Характеризуется протоколом, обеспечивающим возможность нахождения на магистрали нескольких ведущих устройств, обеспечивающим передачу данных в реальном масштабе времени и коррекцию ошибок, высокой помехоустойчивостью.
Рассматриваемый нами узел сети CAN состоит из микроконтроллера, CAN контроллера и приемопередатчика. Некоторые микроконтроллеры имеют встроенный контроллер CAN, такой как STM32 или PIC18F, в то время как другим требуется внешний контроллер CAN, такой как MCP2515. приемопередатчик подключается к витой паре, на концах которой размещены согласующие резисторы с сопротивлением 120 Ом.
Для формирования логической единицы в витой паре, или свободной шине, на оба провода подается напряжение, равное половине разности напряжения между 0 или Vcc. Логическому нулю соответствует подача на провода линии дифференциального напряжения

<p align="center" > <img src="./pic/p21.png"></p>

<p align="center" >Рисунок 4 – ...</p>

<p align="center" > <img src="./pic/p22.png"></p>

<p align="center" >Рисунок 4 – ...</p>

Пакет сообщения CAN
Формат сообщения CAN показан на рисунке
 
 <p align="center" > <img src="./pic/p23.png"></p>

<p align="center" >Рисунок 4 – ...</p>

Идентификатор сообщения используется для идентификации данных, отправленных в этом пакете. Каждое отправленное сообщение принимается всеми узлами сети и в данном случае идентификатор позволяет понять конкретному устройству, необходимо ли обрабатывать данное сообщение. Максимальная длина сообщения 8 байт. 
Арбитраж на шине CAN: первым по шине CAN всегда передается сообщение с наименьшим идентификатором.

### Служебные выводы

#### Режимы загрузки

Микроконтроллер может начать свою работу в одном из трех различных режимов загрузки. Эти режимы выбираются с помощью выводов BOOT0 и BOOT1. От выбранного режима загрузки зависит, какую область карты памяти микроконтроллер будет считать началом памяти. МК может исполнять код программы из Flash памяти, внутреннего статического ОЗУ или системной памяти.
Для работы в обычном режиме вывод BOOT0 необходимо соединить с GND. Если же планируется использование других режимов, необходимо предусмотреть джамперы для задания различных состояний на выводах управления загрузкой.
BOOT1	BOOT0	Режим запуска программы
0	0	Внутренняя FLASH
1	0	
0	1	Системная память
1	1	Внутреннее ОЗУ

 
<p align="center" > <img src="./pic/p26.png"></p>

<p align="center" >Рисунок 4 – ...</p>

Управляющие сигналы для выбора режима загрузки

ПЛИС также имеет специальные выводы, которые задают режим загрузки. В зависимости от состояния этих выводов выбирается нужный режим конфигурации. Рассмотрим, как это происходит на примере Xilinx и Intel (Altera) ПЛИС.
Для Xilinx FPGA
1.	Многорежимный переключатель M[2:0]:
Эти три пина определяют режим загрузки FPGA Xilinx:
Типичная настройка этих пинов:
•	M[2:0] = 001: Master SPI (конфигурация из внешней SPI FLASH).
•	M[2:0] = 101: Slave SPI (приём данных по SPI).
•	M[2:0] = 110: JTAG (конфигурация через JTAG).
Для Intel (Altera) FPGA
MSEL (Configuration Mode Select):
Пины MSEL[3:0] на микросхеме Intel FPGA задают режим загрузки:
•	Активный последовательный (Active serial (AS)).
•	Активный параллельный (Active parallel (AP)).
•	Пассивный последовательный (Passive serial (PS)).
•	Быстрый пассивный параллельный (Fast passive parallel (FPP)).
•	JTAG.

#### Сброс

Начальный сброс требуется любому МК. Организуется он через выводы NRST (активный НИЗКИЙ уровень) или RST (активный ВЫСОКИЙ уровень). В большинстве широкораспространённых моделей используется NRST. Схема подключения данного вывода приведена в спецификации к МК. Ниже показан одна из возможных схем сброса.

<p align="center" > <img src="./pic/p27.png"></p>

<p align="center" >Рисунок 4 – ...</p>

После того как схема включена, изначально конденсатор C12 разряжен и напряжение на RST почти равно нулю и в результате микроконтроллер не запускается. Получается, что после запуска схемы происходит постоянный сброс. С течением времени происходит заряд конденсатора через резистор, после того как он зарежется на выводе RST появится логическая единица, МК запустится. Кнопка же разряжает конденсатор и происходит перезапуск микроконтроллера.
 Задержку перед стартом МК можно посчитать по формуле как T=R*C при данных значения получается приблизительно одна секунда. Для чего эта задержка? Для того чтобы МК не запускался перед тем как все устройства на плате не запитаются и  не перейдут в установившийся режим работы.
GPIO (General Purpose Input/Output).
General Purpose Input/Output — интерфейс, который содержит Входы и Выходы общего назначения, к которым можно подключать разнообразные исполнительные устройства, датчики, дисплеи, контроллеры, разные модули и разную периферию.
GPIO называют «порт общего назначения», поскольку каждый его разряд может быть свободно настроен для работы по приему как входных, так и для формирования выходных цифровых сигналов.
Регистр портов (PDR). Устанавливает направление для каждого внешнего вывода GPIO - либо на ввод, либо на вывод, либо на ввод/вывод (рис. 1).
Регистр входных данных порта (PIDR). Показывает состояние входных контактов.
Регистр выходных данных порта (PODR). Чтобы выводить данные через выходные выводы, программно записываются выходные значения в этот регистр.

<p align="center" > <img src="./pic/p28.png"></p>

<p align="center" >Рисунок 4 – ...</p>

### Подключение периферии через GPIO

Светодиод

<p align="center" > <img src="./pic/p29.png"></p>

<p align="center" >Рисунок 4 – ...</p>

Как видно из рисунка, в правильном подключении светодиода присутствует гасящий резистор, который ограничивает ток через сам светодиод и используемый им выход порта, соответствующий GPIO4.
При прямом подключении без резистора, на светодиод поступит напряжение +3.3В, что есть больше нормы для светодиодов (2-3В). Прямое напряжение такой величины станет причиной резкого возрастания тока в цепи. Такая ситуация может повлечь за собой выгорание светодиода и выхода из строя как отдельного буфера GPIO, так и микропроцессора в целом.

#### Кнопка

Основные варианты подключения кнопки:
1. Нормально разомкнутая (НО) кнопка
 Кнопка размыкает цепь в неактивном состоянии и замыкает при нажатии.
•	Схема подключения:
o	Один контакт кнопки подключается к источнику питания.
o	Второй контакт подключается к нагрузке, которая, в свою очередь, соединена с другим полюсом источника питания.
2. Нормально замкнутая (НЗ) кнопка
В неактивном состоянии кнопка замыкает цепь, а при нажатии размыкает её.
•	Применение: Обычно используется для остановки оборудования, активации аварийных сигналов, защитных систем.
•	Схема подключения:
o	Один контакт подключается к источнику питания.
o	Второй контакт к нагрузке, которая замыкает цепь до нажатия кнопки.

#### Движковый переключатель
Имеет два состояния, одно из которых замыкает одну цепь, а другое – размыкает. Применяется для переключения между двумя устройствами или режимами работы.
•  Схема подключения:

<p align="center" > <img src="./pic/p30.gif"></p>

<p align="center" >Рисунок 4 – ...</p>
